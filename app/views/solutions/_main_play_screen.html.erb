<div id="solution">
  <h2><%= @level.difficulty %> <%= sprintf("%02d",@level.ordinal) %>: <%= @level.name %></h2>
  <div id="program" style="<%= !@solution.code.nil? && @solution.code.size > 4 ? "" : "height: 500px;" %>">
    <% some_code = !(@solution.code.nil? || @solution.code.empty?) %>
    <div class="trash top" <%= some_code ? '' : raw('style="visibility: hidden"')%>>Drop to Remove Command</div>
    <div id="source">
      <% counter = 0 %>
      <% unless some_code %>
        <div id="placeholder">Drop Code Here To Start</div>
      <% end %>
      <% @solution.code.nil? || @solution.code.each do |line| %>
        <% executed = @execution_result0.last_line >= counter ? 'executed' : '' %>
        <div id="<%= counter %>_<%= line %>" class="<%= line %> <%= executed %>"><%= line %></div>
        <% counter += 1 %>
      <% end %>
    </div>
    <%= form_for @solution do |f| %>
      <%= f.hidden_field :level_id, :name => 'level_id' %>
      <div id="code"><%= f.text_area :code, :name => 'code', :value => @solution.code.nil? ? '' : @solution.code.join("\n") %></div>
      <div class="trash bottom" <%= some_code ? '' : raw('style="visibility: hidden"')%>>Drop to Remove Command</div>
      <div id="execute"><%= f.submit 'RUN!' %></div>
    <% end %>
  </div>
  <div id="playfield">
      <% goal_square = @level.goal.carl %>
    <div class="controls">
      <div class="command draggable" id="move"><div>Move</div></div>
      <div class="command draggable" id="turnleft"><div>Turn Left</div></div>
      <div class="command draggable" id="pickbeacon"><div>Pick Beacon</div></div>
      <div class="command draggable" id="putbeacon"><div>Put Beacon</div></div>
      <div class="goals" id="goal-title"><div><h3>Goals:</h3></div></div>
    </div>
    <div class="controls">
      <div class="control-command disabled" id="branch"><div>Branch</div></div>
      <div class="subroutine disabled" id="sub1"><div>Subroutine 1</div></div>
      <div class="goals" id="carl-goal"><div>
          <%= goal_markup(true,@execution_result0.carl_goal_met?,@level.goal,:carl_goal_met?,new,nil) %>
      </div></div>
    </div>
    <div class="controls">
      <div class="control-command disabled" id="loop"><div>Loop</div></div>
      <div class="subroutine disabled" id="sub2"><div>Subroutine 2</div></div>
      <div class="goals" id="loc-goal"><div>
          <%= goal_markup(@execution_result0.lines_of_code_goal?,@execution_result0.lines_of_code_goal_met?,@level.goal,:lines_of_code_goal_met?,new,"No lines of code goals for this level") %>
      </div></div>
    </div>
    <div class="controls">
      <div class="control-command disabled" id="iterate"><div>Iterate</div></div>
      <div class="subroutine disabled" id="sub3"><div>Subroutine 3</div></div>
      <div class="goals" id="beacon-goal"><div>
          <%= goal_markup(@execution_result0.beacon_goals?,@execution_result0.beacon_goals_met?,@level.goal,:beacons_goal_met?,new,"No beacon goals for this level") %>
      </div></div>
    </div>
    <div id="board">
      <div id="execution-result-summary"><div>
        <% if new %>
          <div class="ready"><h4>READY!</h4></div>
        <% else %>
          <% if @execution_result0.exploded? %>
            <div class="explosion"><h4>BOOM!</h4>C.A.R.L. ran into something or did something he couldn't do!  Try Again.</div>
          <% elsif @execution_result0.lines_of_code_goal_met? && @execution_result0.beacon_goals_met? && @execution_result0.carl_goal_met? %>
            <div class="passed"><h4>YAY!</h4>You did it!  Move on to the next level &gt;&gt;</div>
          <% else %>
            <div class="failure"><h4>FAIL.</h4>You didn't meet all the goals; keep working on your code!</div>
          <% end %>
        <% end %>
      </div></div>
      <%
        hidden = ''
        hidden = 'hidden' if @board1.nil?
      %>
      <div id="board0-title" class="board0 <%= hidden %>"><h3>Board 00</h3></div>
      <div id="board1-title" class="board1 <%= hidden %>"><h3>Board 01</h3></div>
      <div class="board-square">0,0</div>
      <% 6.times do |x| %>
        <div class="board-square">&nbsp;</div>
      <% end%>
      <div class="board-square-board0-end">7,0</div>
      <div class="<%= hidden %> board-square">0,0</div>
      <% 6.times do |x| %>
        <div class="<%= hidden %> board-square">&nbsp;</div>
      <% end%>
      <div class="<%= hidden %> board-square-end">7,0</div>
      <% 8.times do |row| %>
        <% 2.times do |board_num| %>
          <% 8.times do |col| %>
            <% 
               board = @board0
               execution_result = @execution_result0
               if board_num == 1
                 board = @board1
                 execution_result = @execution_result1
               end
               klass = "board-square"
               klass = "board-square-end" if board_num == 1 && col == 7
               klass = "board-square-board0-end" if board_num == 0 && col == 7
               klass += " last-row" if row == 7
               klass += " " + hidden if board_num == 1
               square_contents = ''
               unless board.nil?
                 goal = goal_square == [row,col]
                 carl = board.carl?(row,col)
                 explosion = board.map[row][col] == :explosion
                 wall = board.wall?(row,col)
                 beacon = board.beacon?(row,col)

                 if wall
                 square_contents = 'wall'
                 elsif explosion
                   square_contents = 'explode'
                 else
                   if goal && carl
                     square_contents = 'goal-carl-' + execution_result.carl.direction.to_s
                   elsif goal
                     square_contents = 'goal'
                   elsif carl && beacon
                     square_contents = 'beacon-carl-' + execution_result.carl.direction.to_s
                   elsif carl
                     square_contents = 'carl-' + execution_result.carl.direction.to_s
                   elsif beacon
                     square_contents = 'beacon'
                   end
                 end
               end
             %>
             <div class="<%= klass %> board<%= board_num %> <%= square_contents %>" id="board<%= board_num %>-<%= row %>-<%= col %>"><div class="square">&nbsp;</div></div>
          <% end %>
        <% end %>
      <% end %>
      <div class="board-square">0,7</div>
      <% 6.times do |x| %>
        <div class="board-square">&nbsp;</div>
      <% end%>
      <div class="board-square-board0-end">7,7</div>
      <div class="<%= hidden %> board-square">0,7</div>
      <% 6.times do |x| %>
        <div class="<%= hidden %> board-square">&nbsp;</div>
      <% end%>
      <div class="<%= hidden %> board-square-end">7,7</div>
    </div>
  </div>
</div>

